<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste Monitoring - Eco Pulse</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="navbar-injector.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #e8f4f8;
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 24px;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a5490;
        }

        .nav-links {
            display: flex;
            gap: 32px;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: #1a5490;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 16px;
        }

        h1 {
            color: #1a5490;
            text-align: center;
            margin-bottom: 32px;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .waste-display {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 4px solid #f7b801;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }

        .waste-title {
            font-size: 1.125rem;
            color: #666;
            margin-bottom: 24px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .waste-value {
            font-size: 4rem;
            font-weight: 600;
            color: #f7b801;
            margin-bottom: 8px;
        }

        .waste-unit {
            font-size: 1.25rem;
            color: #999;
            margin-bottom: 32px;
        }

        .progress-container {
            margin-bottom: 16px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: #666;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 32px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #f7b801 0%, #ff9500 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .progress-bar.critical {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
        }

        .progress-bar.warning {
            background: linear-gradient(90deg, #f7b801 0%, #ff9500 100%);
        }

        .progress-bar.low {
            background: linear-gradient(90deg, #95e1d3 0%, #4ecdc4 100%);
        }

        .threshold-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #999;
        }

        .alert-section {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 4px solid #e74c3c;
            padding: 24px;
        }

        .alert-title {
            font-size: 1.125rem;
            color: #333;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .alert-item {
            padding: 16px;
            background: #fff5f5;
            border-left: 3px solid #e74c3c;
            font-size: 0.875rem;
            color: #333;
            margin-bottom: 12px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-empty {
            padding: 12px;
            color: #666;
            font-size: 0.875rem;
            font-style: italic;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.safe {
            background: #4ecdc4;
        }

        .status-indicator.warning {
            background: #f7b801;
        }

        .status-indicator.critical {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                height: auto;
                padding: 16px 0;
            }

            .nav-links {
                flex-direction: column;
                gap: 16px;
                text-align: center;
                margin-top: 16px;
            }

            .waste-value {
                font-size: 3rem;
            }

            .container {
                padding: 24px 12px;
            }
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container">
        <h1>Waste Monitoring</h1>
        <p style="text-align: center; color: #666; margin-bottom: 32px; font-size: 0.95rem;">üìã Simulated waste accumulation</p>

        <div class="waste-display">
            <div class="waste-title">Current Waste Level</div>
            <div class="waste-value" id="wasteLevel">-</div>
            <div class="waste-unit">%</div>

            <div class="progress-container">
                <div class="progress-label">
                    <span>0%</span>
                    <span id="statusText">Loading...</span>
                    <span>100%</span>
                </div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                </div>
                <div class="threshold-markers">
                    <span>Low</span>
                    <span>Medium</span>
                    <span>High</span>
                    <span>Critical</span>
                </div>
            </div>
        </div>

        <div class="alert-section">
            <div class="alert-title">Alerts</div>
            <div id="alertContainer">
                <div class="alert-empty">No alerts at this time</div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            // Configuration & constants
            const CONFIG = {
                socketUrl: 'http://localhost:5000',
                wasteThreshold: 80,              // Alert if waste > 80% (critical)
                warningThreshold: 60,            // Alert if waste > 60% (warning)
                fallbackDataInterval: 5000       // Generate fallback data every 5s
            };

            const elements = {
                wasteLevel: document.getElementById('wasteLevel'),
                progressBar: document.getElementById('progressBar'),
                statusText: document.getElementById('statusText'),
                alertContainer: document.getElementById('alertContainer')
            };

            let socket;
            let isConnected = false;
            let fallbackTimer;

            /**
             * Update waste level display and progress bar
             */
            function updateWasteDisplay(level) {
                if (elements.wasteLevel) {
                    elements.wasteLevel.textContent = level;
                }
                
                if (elements.progressBar) {
                    // Update progress bar width and text
                    elements.progressBar.style.width = level + '%';
                    elements.progressBar.textContent = level + '%';

                    // Update progress bar color based on level
                    elements.progressBar.className = 'progress-bar';
                    if (level >= CONFIG.wasteThreshold) {
                        elements.progressBar.classList.add('critical');
                        if (elements.statusText) {
                            elements.statusText.innerHTML = '<span class="status-indicator critical"></span>Critical';
                        }
                    } else if (level >= CONFIG.warningThreshold) {
                        elements.progressBar.classList.add('warning');
                        if (elements.statusText) {
                            elements.statusText.innerHTML = '<span class="status-indicator warning"></span>Warning';
                        }
                    } else {
                        elements.progressBar.classList.add('low');
                        if (elements.statusText) {
                            elements.statusText.innerHTML = '<span class="status-indicator safe"></span>Normal';
                        }
                    }
                }

                console.log('[WASTE] Waste level updated to: ' + level + '%');
            }

            /**
             * Generate alerts based on waste level
             */
            function updateAlerts(level) {
                const alerts = [];

                if (level >= CONFIG.wasteThreshold) {
                    alerts.push({
                        type: 'critical',
                        message: `üö® Critical: Waste level is ${level}% - Immediate pickup required`
                    });
                } else if (level >= CONFIG.warningThreshold) {
                    alerts.push({
                        type: 'warning',
                        message: `‚ö†Ô∏è Warning: Waste level is ${level}% - Schedule pickup soon`
                    });
                }

                renderAlerts(alerts);
            }

            /**
             * Render alert items in the DOM
             */
            function renderAlerts(alerts) {
                if (!elements.alertContainer) return;

                if (alerts.length === 0) {
                    elements.alertContainer.innerHTML = '<div class="alert-empty">‚úì No alerts - waste level is normal</div>';
                    return;
                }

                elements.alertContainer.innerHTML = alerts
                    .map(alert => `<div class="alert-item">${alert.message}</div>`)
                    .join('');
            }

            /**
             * Generate simulated fallback waste data
             */
            function generateFallbackData() {
                return {
                    wasteLevel: Math.floor(Math.random() * 80) + 20  // 20-100%
                };
            }

            /**
             * Process incoming waste data from backend
             */
            function handleWasteData(data) {
                if (data && data.wasteLevel !== undefined) {
                    updateWasteDisplay(data.wasteLevel);
                    updateAlerts(data.wasteLevel);
                }
            }

            /**
             * Initialize Socket.IO connection with event handlers
             */
            function initSocket() {
                try {
                    socket = io(CONFIG.socketUrl, {
                        reconnection: true,
                        reconnectionDelay: 1000,
                        reconnectionDelayMax: 5000,
                        reconnectionAttempts: Infinity
                    });

                    // Connected to server
                    socket.on('connect', function() {
                        isConnected = true;
                        console.log('[SOCKET] Connected to server');
                        
                        // Clear fallback timer when connected
                        if (fallbackTimer) {
                            clearInterval(fallbackTimer);
                            fallbackTimer = null;
                        }
                    });

                    // Disconnected from server
                    socket.on('disconnect', function() {
                        isConnected = false;
                        console.log('[SOCKET] Disconnected - starting fallback data');
                        
                        // Start generating fallback data
                        if (!fallbackTimer) {
                            fallbackTimer = setInterval(function() {
                                const fallbackData = generateFallbackData();
                                handleWasteData(fallbackData);
                            }, CONFIG.fallbackDataInterval);
                        }
                    });

                    // Connection error
                    socket.on('error', function(error) {
                        console.error('[SOCKET ERROR]', error);
                    });

                    // Listen for campus data broadcasts from server (includes waste level)
                    socket.on('campusData', handleWasteData);

                } catch (error) {
                    console.error('[SOCKET INIT ERROR]', error);
                    
                    // Start fallback data if socket init fails
                    if (!fallbackTimer) {
                        fallbackTimer = setInterval(function() {
                            const fallbackData = generateFallbackData();
                            handleWasteData(fallbackData);
                        }, CONFIG.fallbackDataInterval);
                    }
                }
            }

            /**
             * Initialize the page
             */
            function init() {
                console.log('[INIT] Initializing Waste Monitoring page');

                // Try to connect to socket
                initSocket();
                console.log('[INIT] Socket connection initiated');

                // If no connection after 2 seconds, start fallback
                setTimeout(function() {
                    if (!isConnected && !fallbackTimer) {
                        console.log('[INIT] No socket connection after 2s - starting fallback data');
                        fallbackTimer = setInterval(function() {
                            const fallbackData = generateFallbackData();
                            handleWasteData(fallbackData);
                        }, CONFIG.fallbackDataInterval);
                    }
                }, 2000);
            }

            // Start the page when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
